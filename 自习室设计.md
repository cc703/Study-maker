# 自习室功能实现计划

## 功能概述

为学习任务规划系统添加自习室功能，支持多人在线学习、聊天互动、学习计时、任务同步和打卡签到等核心功能。

## 用户需求

- **进入控制**: 需要密码保护
- **人数限制**: 支持设置最大人数
- **信息可见**: 完整展示用户信息（头像、昵称、任务、学习时长）
- **核心功能**:
  - 聊天消息
  - 学习计时
  - 学习打卡
  - 任务同步

## 数据库设计

### 1. study_room (自习室表)

```sql
CREATE TABLE [study_room] (
    id BIGINT IDENTITY(1,1) PRIMARY KEY,
    room_name NVARCHAR(100) NOT NULL,           -- 自习室名称
    room_password NVARCHAR(50) NULL,             -- 密码（可为空）
    max_members INT NOT NULL DEFAULT 10,         -- 最大人数
    creator_id BIGINT NOT NULL DEFAULT 1,        -- 创建者ID
    description NVARCHAR(500) NULL,              -- 描述
    status TINYINT NOT NULL DEFAULT 1,           -- 状态：0-关闭 1-开放
    create_time DATETIME2 NOT NULL DEFAULT GETDATE(),
    update_time DATETIME2 NOT NULL DEFAULT GETDATE()
)
```

### 2. study_room_member (自习室成员表)

```sql
CREATE TABLE [study_room_member] (
    id BIGINT IDENTITY(1,1) PRIMARY KEY,
    room_id BIGINT NOT NULL,                    -- 自习室ID
    user_id BIGINT NOT NULL,                     -- 用户ID
    nickname NVARCHAR(50) NULL,                  -- 显示昵称
    avatar NVARCHAR(255) NULL,                   -- 头像URL
    study_duration INT NOT NULL DEFAULT 0,       -- 本次学习时长（分钟）
    total_study_time INT NOT NULL DEFAULT 0,     -- 总学习时长
    is_active TINYINT NOT NULL DEFAULT 0,        -- 是否在线：0-离线 1-在线
    join_time DATETIME2 NULL,                    -- 加入时间
    last_heartbeat DATETIME2 NULL,               -- 最后心跳时间
    create_time DATETIME2 NOT NULL DEFAULT GETDATE(),
    update_time DATETIME2 NOT NULL DEFAULT GETDATE(),
    UNIQUE (room_id, user_id)
)
```

### 3. chat_message (聊天消息表)

```sql
CREATE TABLE [chat_message] (
    id BIGINT IDENTITY(1,1) PRIMARY KEY,
    room_id BIGINT NOT NULL,                    -- 自习室ID
    user_id BIGINT NOT NULL,                     -- 发送者ID
    nickname NVARCHAR(50) NULL,                  -- 发送者昵称
    avatar NVARCHAR(255) NULL,                   -- 发送者头像
    message_type NVARCHAR(20) NOT NULL DEFAULT 'TEXT', -- 消息类型：TEXT-文本，SYSTEM-系统
    content NVARCHAR(1000) NOT NULL,             -- 消息内容
    create_time DATETIME2 NOT NULL DEFAULT GETDATE()
)
```

### 4. study_check_in (学习打卡表)

```sql
CREATE TABLE [study_check_in] (
    id BIGINT IDENTITY(1,1) PRIMARY KEY,
    room_id BIGINT NOT NULL,                    -- 自习室ID
    user_id BIGINT NOT NULL,                     -- 用户ID
    check_in_date DATE NOT NULL,                 -- 打卡日期
    check_in_count INT NOT NULL DEFAULT 1,       -- 当天打卡次数
    check_in_time DATETIME2 NOT NULL DEFAULT GETDATE(), -- 打卡时间
    remark NVARCHAR(500) NULL,                   -- 打卡备注
    create_time DATETIME2 NOT NULL DEFAULT GETDATE()
)
```

## 后端实现

### 1. 依赖配置 (pom.xml)

添加WebSocket依赖:
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-websocket</artifactId>
</dependency>
```

### 2. WebSocket配置类

文件: `backend/src/main/java/com/planner/config/WebSocketConfig.java`
```java
@Configuration
@EnableWebSocket
public class WebSocketConfig implements WebSocketConfigurer {
    @Override
    public void registerWebSocketHandlers(WebSocketHandlerRegistry registry) {
        registry.addHandler(new StudyRoomHandler(), "/ws/study-room")
                .setAllowedOrigins("*");
    }
}
```

### 3. WebSocket处理器

文件: `backend/src/main/java/com/planner/websocket/StudyRoomHandler.java`
```java
@Component
public class StudyRoomHandler extends TextWebSocketHandler {
    // 维护房间和连接的映射
    private static final Map<Long, Set<WebSocketSession>> ROOM_SESSIONS = new ConcurrentHashMap<>();
    private static final Map<String, Long> SESSION_USER_MAP = new ConcurrentHashMap<>();
    private static final Map<String, Long> SESSION_ROOM_MAP = new ConcurrentHashMap<>();

    @Override
    public void afterConnectionEstablished(WebSocketSession session) throws Exception {
        // 解析连接参数（userId, roomId）
        // 加入房间
    }

    @Override
    protected void handleTextMessage(WebSocketSession session, TextMessage message) throws Exception {
        // 处理消息类型：CHAT, HEARTBEAT, TIMER_UPDATE, CHECK_IN, TASK_SYNC
    }

    @Override
    public void afterConnectionClosed(WebSocketSession session, CloseStatus status) throws Exception {
        // 退出房间
        // 更新用户在线状态
    }

    // 广播消息到房间
    public void broadcastToRoom(Long roomId, String message) {
        Set<WebSocketSession> sessions = ROOM_SESSIONS.get(roomId);
        if (sessions != null) {
            sessions.forEach(session -> sendMessage(session, message));
        }
    }
}
```

### 4. Entity类

创建以下实体类:
- `backend/src/main/java/com/planner/entity/StudyRoom.java`
- `backend/src/main/java/com/planner/entity/StudyRoomMember.java`
- `backend/src/main/java/com/planner/entity/ChatMessage.java`
- `backend/src/main/java/com/planner/entity/StudyCheckIn.java`

### 5. Mapper接口

- `backend/src/main/java/com/planner/mapper/StudyRoomMapper.java`
- `backend/src/main/java/com/planner/mapper/StudyRoomMemberMapper.java`
- `backend/src/main/java/com/planner/mapper/ChatMessageMapper.java`
- `backend/src/main/java/com/planner/mapper/StudyCheckInMapper.java`

### 6. Service层

- `backend/src/main/java/com/planner/service/StudyRoomService.java` (接口)
- `backend/src/main/java/com/planner/service/impl/StudyRoomServiceImpl.java` (实现)
- `backend/src/main/java/com/planner/service/StudyRoomMemberService.java` (接口)
- `backend/src/main/java/com/planner/service/impl/StudyRoomMemberServiceImpl.java` (实现)

### 7. Controller层

文件: `backend/src/main/java/com/planner/controller/StudyRoomController.java`

API端点:
- `GET /api/study-rooms` - 获取自习室列表
- `GET /api/study-rooms/{id}` - 获取自习室详情
- `POST /api/study-rooms` - 创建自习室
- `PUT /api/study-rooms` - 更新自习室
- `DELETE /api/study-rooms/{id}` - 删除自习室
- `POST /api/study-rooms/{id}/join` - 加入自习室（密码验证）
- `POST /api/study-rooms/{id}/leave` - 退出自习室
- `GET /api/study-rooms/{id}/members` - 获取房间成员
- `POST /api/study-rooms/{id}/check-in` - 学习打卡

文件: `backend/src/main/java/com/planner/controller/ChatMessageController.java`

API端点:
- `GET /api/study-rooms/{id}/messages` - 获取聊天记录（分页）

### 8. DTO和VO类

- `backend/src/main/java/com/planner/dto/StudyRoomDTO.java`
- `backend/src/main/java/com/planner/dto/StudyRoomQueryDTO.java`
- `backend/src/main/java/com/planner/vo/StudyRoomDetailVO.java` (包含成员列表、学习统计)
- `backend/src/main/java/com/planner/vo/StudyRoomMemberVO.java`

## 前端实现

### 1. API层

文件: `frontend/src/api/study-room.js`
```javascript
import request from '@/utils/request'

export function getStudyRoomList() {
    return request.get('/study-rooms')
}

export function getStudyRoomDetail(id) {
    return request.get(`/study-rooms/${id}`)
}

export function createStudyRoom(data) {
    return request.post('/study-rooms', data)
}

export function updateStudyRoom(data) {
    return request.put('/study-rooms', data)
}

export function deleteStudyRoom(id) {
    return request.delete(`/study-rooms/${id}`)
}

export function joinStudyRoom(id, password) {
    return request.post(`/study-rooms/${id}/join`, { password })
}

export function leaveStudyRoom(id) {
    return request.post(`/study-rooms/${id}/leave`)
}

export function getRoomMembers(id) {
    return request.get(`/study-rooms/${id}/members`)
}

export function checkIn(roomId) {
    return request.post(`/study-rooms/${roomId}/check-in`)
}

export function getChatMessages(roomId, page = 1, size = 50) {
    return request.get(`/study-rooms/${roomId}/messages?page=${page}&size=${size}`)
}
```

### 2. WebSocket客户端工具

文件: `frontend/src/utils/websocket.js`
```javascript
class StudyRoomWebSocket {
    constructor(roomId, userId, callbacks) {
        this.roomId = roomId
        this.userId = userId
        this.ws = null
        this.callbacks = callbacks
        this.reconnectAttempts = 0
        this.maxReconnectAttempts = 5
        this.heartbeatInterval = null
        this.connect()
    }

    connect() {
        const wsUrl = `ws://localhost:8080/ws/study-room?roomId=${this.roomId}&userId=${this.userId}`
        this.ws = new WebSocket(wsUrl)

        this.ws.onopen = () => {
            console.log('WebSocket connected')
            this.reconnectAttempts = 0
            this.startHeartbeat()
            if (this.callbacks.onOpen) this.callbacks.onOpen()
        }

        this.ws.onmessage = (event) => {
            const data = JSON.parse(event.data)
            this.handleMessage(data)
        }

        this.ws.onclose = () => {
            console.log('WebSocket disconnected')
            this.stopHeartbeat()
            if (this.callbacks.onClose) this.callbacks.onClose()
            this.reconnect()
        }

        this.ws.onerror = (error) => {
            console.error('WebSocket error:', error)
            if (this.callbacks.onError) this.callbacks.onError(error)
        }
    }

    handleMessage(data) {
        switch (data.type) {
            case 'CHAT':
                if (this.callbacks.onChat) this.callbacks.onChat(data)
                break
            case 'MEMBER_JOIN':
                if (this.callbacks.onMemberJoin) this.callbacks.onMemberJoin(data)
                break
            case 'MEMBER_LEAVE':
                if (this.callbacks.onMemberLeave) this.callbacks.onMemberLeave(data)
                break
            case 'TIMER_UPDATE':
                if (this.callbacks.onTimerUpdate) this.callbacks.onTimerUpdate(data)
                break
            case 'CHECK_IN':
                if (this.callbacks.onCheckIn) this.callbacks.onCheckIn(data)
                break
            case 'TASK_SYNC':
                if (this.callbacks.onTaskSync) this.callbacks.onTaskSync(data)
                break
            case 'SYSTEM':
                if (this.callbacks.onSystem) this.callbacks.onSystem(data)
                break
        }
    }

    send(type, payload = {}) {
        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
            this.ws.send(JSON.stringify({ type, ...payload, roomId: this.roomId, userId: this.userId }))
        }
    }

    sendChat(content) {
        this.send('CHAT', { content })
    }

    sendHeartbeat() {
        this.send('HEARTBEAT')
    }

    startHeartbeat() {
        this.heartbeatInterval = setInterval(() => {
            this.sendHeartbeat()
        }, 30000)
    }

    stopHeartbeat() {
        if (this.heartbeatInterval) {
            clearInterval(this.heartbeatInterval)
            this.heartbeatInterval = null
        }
    }

    reconnect() {
        if (this.reconnectAttempts < this.maxReconnectAttempts) {
            this.reconnectAttempts++
            setTimeout(() => {
                console.log(`Reconnecting... Attempt ${this.reconnectAttempts}`)
                this.connect()
            }, 3000)
        }
    }

    disconnect() {
        this.stopHeartbeat()
        if (this.ws) {
            this.ws.close()
        }
    }
}

export default StudyRoomWebSocket
```

### 3. Pinia Store

文件: `frontend/src/store/study-room.js`
```javascript
import { defineStore } from 'pinia'
import { getStudyRoomList, createStudyRoom, joinStudyRoom, leaveStudyRoom } from '@/api/study-room'

export const useStudyRoomStore = defineStore('studyRoom', {
    state: () => ({
        roomList: [],
        currentRoom: null,
        currentMembers: [],
        chatMessages: [],
        isJoined: false,
        wsConnection: null
    }),

    getters: {
        roomMemberCount: (state) => state.currentMembers.length,
        onlineMembers: (state) => state.currentMembers.filter(m => m.isActive)
    },

    actions: {
        async fetchRoomList() {
            const res = await getStudyRoomList()
            this.roomList = res.data || []
            return this.roomList
        },

        async createRoom(data) {
            await createStudyRoom(data)
            await this.fetchRoomList()
        },

        async joinRoom(roomId, password) {
            await joinStudyRoom(roomId, password)
            this.isJoined = true
        },

        async leaveRoom(roomId) {
            await leaveStudyRoom(roomId)
            this.isJoined = false
            if (this.wsConnection) {
                this.wsConnection.disconnect()
                this.wsConnection = null
            }
        },

        addChatMessage(message) {
            this.chatMessages.push(message)
        }
    }
})
```

### 4. 自习室列表页面

文件: `frontend/src/views/study-room/index.vue`

功能:
- 显示自习室列表（卡片式布局）
- 创建自习室按钮
- 显示房间信息（名称、人数、描述）
- 加入房间操作（密码验证弹窗）
- 创建房间弹窗

### 5. 自习室详情页面

文件: `frontend/src/views/study-room/detail.vue`

页面布局:
```
┌─────────────────────────────────────────────────────────┐
│  返回按钮  房间名称  [打卡] [分享]                       │
├──────────────────────┬──────────────────────────────────┤
│                      │  在线成员列表                     │
│                      │  ┌─────────────┐                │
│                      │  │ 头像 昵称    │                │
│   聊天消息区域       │  │ 学习时长    │                │
│   ┌──────────────┐   │  └─────────────┘                │
│   │ 消息列表     │   │                                  │
│   │              │   │  ┌─────────────┐                │
│   │              │   │  │ 头像 昵称    │                │
│   └──────────────┘   │  │ 学习时长    │                │
│                      │  └─────────────┘                │
│   [输入框] [发送]    │                                  │
├──────────────────────┴──────────────────────────────────┤
│  学习计时器                                              │
│  [开始学习] [暂停] [结束]                               │
│  本次学习时长: 00:00:00                                 │
└─────────────────────────────────────────────────────────┘
```

功能模块:
1. **顶部栏**: 房间信息、打卡按钮、退出按钮
2. **聊天区域**: 消息列表、输入框、发送按钮
3. **成员列表**: 实时显示在线成员及其学习时长
4. **学习计时器**: 开始、暂停、结束学习，实时更新时长

### 6. 路由配置

更新 `frontend/src/router/index.js`:
```javascript
{
    path: 'study-room',
    name: 'StudyRoom',
    component: () => import('@/views/study-room/index.vue'),
    meta: { title: '自习室', icon: 'ChatLineRound' }
},
{
    path: 'study-room/:id',
    name: 'StudyRoomDetail',
    component: () => import('@/views/study-room/detail.vue'),
    meta: { title: '自习室详情', icon: 'ChatLineRound' }
}
```

### 7. 侧边栏菜单

更新 `frontend/src/views/layout/Layout.vue`:
添加自习室菜单项

## WebSocket消息格式

### 客户端 → 服务器

```json
{
  "type": "CHAT|HEARTBEAT|TIMER_UPDATE|CHECK_IN|TASK_SYNC",
  "roomId": 1,
  "userId": 1,
  "content": "消息内容"  // 仅CHAT类型需要
}
```

### 服务器 → 客户端

```json
{
  "type": "CHAT|MEMBER_JOIN|MEMBER_LEAVE|TIMER_UPDATE|CHECK_IN|TASK_SYNC|SYSTEM",
  "userId": 1,
  "nickname": "用户昵称",
  "avatar": "头像URL",
  "content": "消息内容",
  "timestamp": "2024-01-21 10:00:00"
}
```

## 实现阶段

### 阶段1: 数据库和基础后端 (核心)
1. 创建数据库表
2. 创建Entity、Mapper、Service、Controller
3. 实现自习室CRUD API
4. 实现成员管理API
5. 实现打卡API

### 阶段2: WebSocket实时通信 (核心)
1. 添加WebSocket依赖
2. 配置WebSocket
3. 实现WebSocket处理器
4. 实现消息广播机制
5. 实现心跳机制和在线状态管理

### 阶段3: 基础前端页面
1. 创建API层
2. 创建Pinia store
3. 创建自习室列表页面
4. 添加路由和菜单

### 阶段4: 实时功能集成
1. 创建WebSocket客户端工具
2. 创建自习室详情页面
3. 实现聊天功能
4. 实现成员列表实时更新

### 阶段5: 学习计时和打卡
1. 实现学习计时器UI
2. 实现计时器与WebSocket同步
3. 实现打卡功能
4. 添加学习时长统计

### 阶段6: 任务同步 (可选)
1. 获取用户当前任务列表
2. 实现任务状态同步
3. 在详情页展示成员任务

## 关键文件清单

### 后端文件
- `backend/pom.xml` - 添加WebSocket依赖
- `backend/src/main/java/com/planner/config/WebSocketConfig.java`
- `backend/src/main/java/com/planner/websocket/StudyRoomHandler.java`
- `backend/src/main/java/com/planner/entity/StudyRoom.java`
- `backend/src/main/java/com/planner/entity/StudyRoomMember.java`
- `backend/src/main/java/com/planner/entity/ChatMessage.java`
- `backend/src/main/java/com/planner/entity/StudyCheckIn.java`
- `backend/src/main/java/com/planner/mapper/StudyRoomMapper.java`
- `backend/src/main/java/com/planner/mapper/StudyRoomMemberMapper.java`
- `backend/src/main/java/com/planner/mapper/ChatMessageMapper.java`
- `backend/src/main/java/com/planner/mapper/StudyCheckInMapper.java`
- `backend/src/main/java/com/planner/service/StudyRoomService.java`
- `backend/src/main/java/com/planner/service/impl/StudyRoomServiceImpl.java`
- `backend/src/main/java/com/planner/service/StudyRoomMemberService.java`
- `backend/src/main/java/com/planner/service/impl/StudyRoomMemberServiceImpl.java`
- `backend/src/main/java/com/planner/controller/StudyRoomController.java`
- `backend/src/main/java/com/planner/controller/ChatMessageController.java`
- `backend/src/main/java/com/planner/dto/StudyRoomDTO.java`
- `backend/src/main/java/com/planner/vo/StudyRoomDetailVO.java`
- `backend/src/main/java/com/planner/vo/StudyRoomMemberVO.java`

### 前端文件
- `frontend/src/api/study-room.js`
- `frontend/src/utils/websocket.js`
- `frontend/src/store/study-room.js`
- `frontend/src/views/study-room/index.vue`
- `frontend/src/views/study-room/detail.vue`
- `frontend/src/router/index.js` - 更新
- `frontend/src/views/layout/Layout.vue` - 更新

### 数据库文件
- `database/init.sql` - 添加新表

## 测试验证

### 功能测试
1. 创建自习室（设置密码和人数限制）
2. 加入自习室（密码验证）
3. 多用户加入同一房间
4. 发送聊天消息并验证实时性
5. 打卡功能
6. 学习计时器功能
7. 退出房间

### 异常测试
1. 密码错误无法加入
2. 超出人数限制
3. WebSocket断线重连
4. 非法消息类型

### 性能测试
1. 多房间并发
2. 大量消息处理
3. 长时间连接稳定性

## 注意事项

1. **安全性**:
   - 密码需要加密存储
   - WebSocket消息需要验证用户身份
   - 防止XSS和SQL注入

2. **用户体验**:
   - 使用墨韵专注主题风格
   - 动画效果要流畅
   - 消息提示要友好

3. **兼容性**:
   - 考虑浏览器WebSocket兼容性
   - 提供降级方案（轮询）

4. **数据一致性**:
   - 学习时长需要实时持久化
   - 在线状态需要定时清理
